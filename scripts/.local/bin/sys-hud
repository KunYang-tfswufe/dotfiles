#!/bin/bash

# ================= 配置区域 =================
APP_ID="sys_hud"
WINDOW_TITLE="System HUD"
# 窗口样式参数 (传给 foot)
FOOT_ARGS=(-a "$APP_ID" -T "$WINDOW_TITLE" -o 'colors.background=000000' -o 'colors.alpha=0.9' -o 'font=monospace:size=10')
# ===========================================

# >>>>> 逻辑分支 1：控制模式 (Toggle) <<<<<
if [[ "$1" == "toggle" ]]; then
    if pgrep -f "foot -a $APP_ID" > /dev/null; then
        pkill -f "foot -a $APP_ID"
    else
        foot "${FOOT_ARGS[@]}" "$0" daemon &
    fi
    exit 0
fi

# >>>>> 逻辑分支 2：显示模式 (Daemon) <<<<<

# 隐藏光标
tput civis
# 退出时恢复光标
trap 'tput cnorm; clear; exit' SIGINT SIGTERM

# --- 辅助函数 ---

get_volume() {
    # 适配 PulseAudio/Pipewire
    vol=$(pactl get-sink-volume @DEFAULT_SINK@ 2>/dev/null | grep -oP '\d+%' | head -1 | tr -d '%')
    mute=$(pactl get-sink-mute @DEFAULT_SINK@ 2>/dev/null | cut -d: -f2)
    if [ "$mute" == " yes" ]; then echo "[Muted]"; else echo "${vol:-0}%"; fi
}

get_brightness() {
    if command -v brightnessctl &> /dev/null; then
        c=$(brightnessctl g); m=$(brightnessctl m)
        echo $(( 100 * c / m ))"%"
    else echo "N/A"; fi
}

get_battery() {
    BAT=$(find /sys/class/power_supply/ -name "BAT*" | head -n 1)
    if [ -n "$BAT" ]; then
        s=$(cat "$BAT/status"); c=$(cat "$BAT/capacity")
        [ "$s" == "Charging" ] && icon="CHR" || icon="BAT"
        echo "$icon $c%"
    else 
        echo "AC-Pwr"; 
    fi
}

# --- 主循环 ---

while true; do
    # 绘图
    tput cup 0 0
    B=$(tput bold); N=$(tput sgr0)
    G=$(tput setaf 2); Y=$(tput setaf 3); C=$(tput setaf 6); W=$(tput setaf 7)

    echo "${B}${C}╔════════════ SYSTEM HUD ════════════╗${N}"
    printf "║ ${Y}Time:${N} %-28s ║\n" "$(date '+%H:%M:%S')"
    printf "║ ${Y}Date:${N} %-28s ║\n" "$(date '+%Y-%m-%d %a')"
    echo "║ ---------------------------------- ║"
    printf "║ ${G}Bat :${N} %-10s ${G}Brit:${N} %-10s  ║\n" "$(get_battery)" "$(get_brightness)"
    printf "║ ${G}Net :${N} %-28s ║\n" "$(hostname -I | awk '{print $1}')"
    echo "║ ---------------------------------- ║"
    printf "║ ${C}Vol :${N} %-28s ║\n" "$(get_volume)"
    echo "${B}${C}╚════════════════════════════════════╝${N}"

    sleep 1
done
