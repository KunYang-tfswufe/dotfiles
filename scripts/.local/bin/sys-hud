#!/bin/bash

# ================= é…ç½®åŒºåŸŸ =================
APP_ID="sys_hud"
WINDOW_TITLE="System HUD"
# çª—å£æ ·å¼å‚æ•° (ä¼ ç»™ foot)
FOOT_ARGS=(-a "$APP_ID" -T "$WINDOW_TITLE" -o 'colors.background=000000' -o 'colors.alpha=0.9' -o 'font=monospace:size=10')
# ===========================================

# >>>>> é€»è¾‘åˆ†æ”¯ 1ï¼šæ§åˆ¶æ¨¡å¼ (Toggle) <<<<<
if [[ "$1" == "toggle" ]]; then
    if pgrep -f "foot -a $APP_ID" > /dev/null; then
        pkill -f "foot -a $APP_ID"
    else
        foot "${FOOT_ARGS[@]}" "$0" daemon &
    fi
    exit 0
fi

# >>>>> é€»è¾‘åˆ†æ”¯ 2ï¼šæ˜¾ç¤ºæ¨¡å¼ (Daemon) <<<<<

# éšè—å…‰æ ‡
tput civis
# é€€å‡ºæ—¶æ¢å¤å…‰æ ‡
trap 'tput cnorm; clear; exit' SIGINT SIGTERM

# --- è¾…åŠ©å‡½æ•° (å·²ç§»é™¤å›¾æ ‡) ---
get_bar() {
    local percent=$1
    local num=$(($percent / 5))
    local bar="####################"
    local spaces="...................."
    echo "[${bar:0:num}${spaces:0:20-$num}]"
}

get_volume() {
    # é€‚é… PulseAudio/Pipewire
    vol=$(pactl get-sink-volume @DEFAULT_SINK@ 2>/dev/null | grep -oP '\d+%' | head -1 | tr -d '%')
    mute=$(pactl get-sink-mute @DEFAULT_SINK@ 2>/dev/null | cut -d: -f2)
    # ä¿®æ”¹ï¼šç§»é™¤ ğŸ”‡/ğŸ”Šï¼Œæ”¹ä¸ºæ–‡å­—
    if [ "$mute" == " yes" ]; then echo "[Muted]"; else echo "${vol:-0}%"; fi
}

get_brightness() {
    if command -v brightnessctl &> /dev/null; then
        c=$(brightnessctl g); m=$(brightnessctl m)
        echo $(( 100 * c / m ))"%"
    else echo "N/A"; fi
}

get_battery() {
    BAT=$(find /sys/class/power_supply/ -name "BAT*" | head -n 1)
    if [ -n "$BAT" ]; then
        s=$(cat "$BAT/status"); c=$(cat "$BAT/capacity")
        # ä¿®æ”¹ï¼šç§»é™¤ âš¡/Pbï¼Œæ”¹ä¸º CHR/BAT
        [ "$s" == "Charging" ] && icon="CHR" || icon="BAT"
        echo "$icon $c%"
    else 
        # ä¿®æ”¹ï¼šç§»é™¤ ğŸ”Œï¼Œæ”¹ä¸º AC
        echo "AC-Pwr"; 
    fi
}

get_temp() {
    # ä¿®æ”¹ï¼šç§»é™¤ Â° ç¬¦å·ï¼Œé˜²æ­¢ç¼–ç é—®é¢˜
    [ -f /sys/class/thermal/thermal_zone0/temp ] && echo $(( $(cat /sys/class/thermal/thermal_zone0/temp) / 1000 ))"C" || echo "N/A"
}

# --- ä¸»å¾ªç¯ ---
prev_total=0; prev_idle=0

while true; do
    # CPU è®¡ç®—
    read -r cpu a b c idle rest < /proc/stat
    total=$((a+b+c+idle)); diff_total=$((total-prev_total)); diff_idle=$((idle-prev_idle))
    if [ $diff_total -eq 0 ]; then cpu_usage=0; else cpu_usage=$((100*(diff_total-diff_idle)/diff_total)); fi
    prev_total=$total; prev_idle=$idle

    # å†…å­˜è®¡ç®—
    mem_used=$(free -m | awk '/Mem:/ {print $3}')
    mem_total=$(free -m | awk '/Mem:/ {print $2}')
    mem_percent=$(( 100 * mem_used / mem_total ))

    # ç»˜å›¾
    tput cup 0 0
    BOLD=$(tput bold); NORM=$(tput sgr0)
    G=$(tput setaf 2); Y=$(tput setaf 3); C=$(tput setaf 6); R=$(tput setaf 1)

    # è¾¹æ¡†å­—ç¬¦è¯´æ˜ï¼š
    # è™½ç„¶è¿™é‡Œä¿ç•™äº†åŒçº¿æ¡†(â•”â•â•—)ï¼Œä½†è¿™äº›æ˜¯æ ‡å‡† IBM PC å­—ç¬¦é›†ï¼Œ
    # å‡ ä¹æ‰€æœ‰ç»ˆç«¯ï¼ˆåŒ…æ‹¬ Windows CMDï¼‰éƒ½åŸç”Ÿæ”¯æŒï¼Œä¸éœ€è¦ Nerd Fontsã€‚
    # åªè¦ä¸å‡ºç° Emoji å½©è‰²å›¾æ ‡ï¼Œå°±ä¸ä¼šæœ‰å…¼å®¹æ€§é—®é¢˜ã€‚
    
    echo "${BOLD}${C}â•”â•â•â•â•â•â•â•â•â•â•â•â• SYSTEM HUD â•â•â•â•â•â•â•â•â•â•â•â•â•—${NORM}"
    printf "â•‘ ${Y}Time:${NORM} %-28s â•‘\n" "$(date '+%H:%M:%S')"
    printf "â•‘ ${Y}Date:${NORM} %-28s â•‘\n" "$(date '+%Y-%m-%d %a')"
    echo "â•‘ ---------------------------------- â•‘"
    printf "â•‘ ${G}Bat :${NORM} %-10s ${G}Brit:${NORM} %-10s â•‘\n" "$(get_battery)" "$(get_brightness)"
    printf "â•‘ ${G}Net :${NORM} %-28s â•‘\n" "$(hostname -I | awk '{print $1}')"
    echo "â•‘ ---------------------------------- â•‘"
    printf "â•‘ ${R}CPU :${NORM} %-4s %s â•‘\n" "${cpu_usage}%" "$(get_bar $cpu_usage)"
    printf "â•‘ ${R}RAM :${NORM} %-4s %s â•‘\n" "${mem_percent}%" "$(get_bar $mem_percent)"
    printf "â•‘ ${R}Temp:${NORM} %-28s â•‘\n" "$(get_temp)"
    echo "â•‘ ---------------------------------- â•‘"
    printf "â•‘ ${C}Vol :${NORM} %-28s â•‘\n" "$(get_volume)"
    echo "${BOLD}${C}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NORM}"

    sleep 1
done
