#!/bin/bash

# ================= é…ç½®åŒºåŸŸ =================
APP_ID="sys_hud"
WINDOW_TITLE="System HUD"
# çª—å£æ ·å¼å‚æ•° (ä¼ ç»™ foot)
FOOT_ARGS=(-a "$APP_ID" -T "$WINDOW_TITLE" -o 'colors.background=000000' -o 'colors.alpha=0.9' -o 'font=monospace:size=10')
# ===========================================

# >>>>> é€»è¾‘åˆ†æ”¯ 1ï¼šæ§åˆ¶æ¨¡å¼ (Toggle) <<<<<
# å¦‚æœä¼ å…¥äº† "toggle" å‚æ•°ï¼Œåˆ™æ‰§è¡Œå¼€å…³é€»è¾‘
if [[ "$1" == "toggle" ]]; then
    # æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é… APP_ID çš„ foot è¿›ç¨‹
    if pgrep -f "foot -a $APP_ID" > /dev/null; then
        # å­˜åœ¨åˆ™å…³é—­
        pkill -f "foot -a $APP_ID"
    else
        # ä¸å­˜åœ¨åˆ™å¯åŠ¨
        # æ³¨æ„ï¼šè¿™é‡Œ "$0" ä»£è¡¨è„šæœ¬è‡ªèº«çš„è·¯å¾„ï¼Œå®ç°è‡ªè°ƒç”¨
        # æˆ‘ä»¬å¯åŠ¨ footï¼Œè®© foot å†è¿è¡Œè¿™ä¸ªè„šæœ¬çš„ "daemon" æ¨¡å¼
        foot "${FOOT_ARGS[@]}" "$0" daemon &
    fi
    exit 0
fi

# >>>>> é€»è¾‘åˆ†æ”¯ 2ï¼šæ˜¾ç¤ºæ¨¡å¼ (Daemon) <<<<<
# ä¸‹é¢æ˜¯åŸæœ¬çš„æ˜¾ç¤ºé€»è¾‘ï¼Œåªæœ‰è¢«ä¸Šé¢çš„ toggle åˆ†æ”¯å¯åŠ¨æ—¶æ‰ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ

# éšè—å…‰æ ‡
tput civis
# é€€å‡ºæ—¶æ¢å¤å…‰æ ‡
trap 'tput cnorm; clear; exit' SIGINT SIGTERM

# --- è¾…åŠ©å‡½æ•° ---
get_bar() {
    local percent=$1
    local num=$(($percent / 5))
    local bar="####################"
    local spaces="...................."
    echo "[${bar:0:num}${spaces:0:20-$num}]"
}

get_volume() {
    # é€‚é… PulseAudio/Pipewire
    vol=$(pactl get-sink-volume @DEFAULT_SINK@ 2>/dev/null | grep -oP '\d+%' | head -1 | tr -d '%')
    mute=$(pactl get-sink-mute @DEFAULT_SINK@ 2>/dev/null | cut -d: -f2)
    if [ "$mute" == " yes" ]; then echo "ğŸ”‡ Muted"; else echo "ğŸ”Š ${vol:-0}%"; fi
}

get_brightness() {
    if command -v brightnessctl &> /dev/null; then
        c=$(brightnessctl g); m=$(brightnessctl m)
        echo $(( 100 * c / m ))"%"
    else echo "N/A"; fi
}

get_battery() {
    BAT=$(find /sys/class/power_supply/ -name "BAT*" | head -n 1)
    if [ -n "$BAT" ]; then
        s=$(cat "$BAT/status"); c=$(cat "$BAT/capacity")
        [ "$s" == "Charging" ] && icon="âš¡" || icon="Pb"
        echo "$icon $c%"
    else echo "ğŸ”Œ AC"; fi
}

get_temp() {
    [ -f /sys/class/thermal/thermal_zone0/temp ] && echo $(( $(cat /sys/class/thermal/thermal_zone0/temp) / 1000 ))"Â°C" || echo "N/A"
}

# --- ä¸»å¾ªç¯ ---
prev_total=0; prev_idle=0

while true; do
    # CPU è®¡ç®—
    read -r cpu a b c idle rest < /proc/stat
    total=$((a+b+c+idle)); diff_total=$((total-prev_total)); diff_idle=$((idle-prev_idle))
    if [ $diff_total -eq 0 ]; then cpu_usage=0; else cpu_usage=$((100*(diff_total-diff_idle)/diff_total)); fi
    prev_total=$total; prev_idle=$idle

    # å†…å­˜è®¡ç®—
    mem_used=$(free -m | awk '/Mem:/ {print $3}')
    mem_total=$(free -m | awk '/Mem:/ {print $2}')
    mem_percent=$(( 100 * mem_used / mem_total ))

    # ç»˜å›¾
    tput cup 0 0
    BOLD=$(tput bold); NORM=$(tput sgr0)
    G=$(tput setaf 2); Y=$(tput setaf 3); C=$(tput setaf 6); R=$(tput setaf 1)

    echo "${BOLD}${C}â•”â•â•â•â•â•â•â•â•â•â•â•â• SYSTEM HUD â•â•â•â•â•â•â•â•â•â•â•â•â•—${NORM}"
    printf "â•‘ ${Y}Time:${NORM} %-28s â•‘\n" "$(date '+%H:%M:%S')"
    printf "â•‘ ${Y}Date:${NORM} %-28s â•‘\n" "$(date '+%Y-%m-%d %a')"
    echo "â•‘ ---------------------------------- â•‘"
    printf "â•‘ ${G}Bat :${NORM} %-10s ${G}Brit:${NORM} %-10s  â•‘\n" "$(get_battery)" "$(get_brightness)"
    printf "â•‘ ${G}Net :${NORM} %-28s â•‘\n" "$(hostname -I | awk '{print $1}')"
    echo "â•‘ ---------------------------------- â•‘"
    printf "â•‘ ${R}CPU :${NORM} %-4s %s  â•‘\n" "${cpu_usage}%" "$(get_bar $cpu_usage)"
    printf "â•‘ ${R}RAM :${NORM} %-4s %s  â•‘\n" "${mem_percent}%" "$(get_bar $mem_percent)"
    printf "â•‘ ${R}Temp:${NORM} %-28s  â•‘\n" "$(get_temp)"
    echo "â•‘ ---------------------------------- â•‘"
    printf "â•‘ ${C}Vol :${NORM} %-28s   â•‘\n" "$(get_volume)"
    echo "${BOLD}${C}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NORM}"

    sleep 1
done
